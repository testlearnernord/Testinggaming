<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
<title>Mais & 💩 — Single-File</title>
<style>
  :root { --safe-bottom: env(safe-area-inset-bottom, 0px); --safe-top: env(safe-area-inset-top, 0px); }
  html, body { margin:0; padding:0; background:#0b0f12; color:#f2f2f2; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji", sans-serif; height:100%; }
  #canvas { display:block; width:100vw; height:100vh; touch-action:none; background:#0b0f12; }
  #ui { position: fixed; top: calc(0px + var(--safe-top)); left: 0; right: 0; display:flex; gap:.5rem; padding:.55rem .6rem; align-items:center; flex-wrap:wrap; background: rgba(0,0,0,.45); backdrop-filter: blur(8px); z-index:10; }
  .pill { padding:.45rem .65rem; border:1px solid #33404d; border-radius: 999px; background:#18222c; font-weight:700; }
  .btn { padding:.7rem 1rem; border-radius:1rem; background:#2563eb; border:none; color:#fff; font-weight:800; box-shadow: 0 3px 0 #1b48a8; z-index:11; }
  .btn:disabled { background:#3b4551; box-shadow:none; opacity:.8; }
  #hud { margin-left:auto; display:flex; gap:.5rem; align-items:center; font-weight:600; }
  #toast { position:fixed; bottom: calc(10.5rem + var(--safe-bottom)); left:50%; transform: translateX(-50%); background:rgba(0,0,0,.8); padding:.7rem 1rem; border-radius:.9rem; opacity:0; transition: opacity .3s; font-weight:800; z-index:10; }
  #dpad { position:fixed; bottom: calc(2.5rem + var(--safe-bottom)); left:1rem; display:grid; grid-template-columns: repeat(3, 72px); grid-template-rows: repeat(3, 72px); gap:8px; opacity:.98; z-index:11; }
  #dpad button { background:#18222c; border:2px solid #33404d; border-radius:18px; font-size:26px; color:#f2f2f2; }
  #actions { position:fixed; bottom: calc(2.5rem + var(--safe-bottom)); right:1rem; display:flex; flex-direction:column; gap:10px; z-index:11; }
  .hint { font-size:.95rem; opacity:.95; }
  #debug { position:fixed; bottom: calc(0.5rem + var(--safe-bottom)); left: 0.6rem; right: 0.6rem; display:flex; gap:.5rem; justify-content:space-between; z-index:12; }
  #debug button { background:#11181f; color:#d0e1ff; border:1px solid #33404d; border-radius:.7rem; padding:.5rem .7rem; font-weight:700; }
</style>
</head>
<body>
<canvas id="canvas"></canvas>

<div id="ui">
  <span class="pill">🪨 Steine: <b id="stones">0</b></span>
  <span class="pill">💩 Kacke: <b id="poops">0</b></span>
  <span class="pill">🌽 Mais: <b id="corns">0</b></span>
  <span class="pill">⏱️ Pflanzungen: <b id="plants">0</b></span>
  <div id="hud" class="hint">Sammle Steine. Händler unten rechts.</div>
</div>

<div id="toast"></div>

<div id="dpad" aria-label="Steuerkreuz">
  <div></div><button data-dir="up">▲</button><div></div>
  <button data-dir="left">◀</button><div></div><button data-dir="right">▶</button>
  <div></div><button data-dir="down">▼</button><div></div>
</div>

<div id="actions">
  <button class="btn" id="btnPlant" disabled>🌱 Düngen (1 💩)</button>
  <button class="btn" id="btnTrade" disabled>🤝 5 🪨 → 1 💩</button>
  <button class="btn" id="btnSellCorn" disabled>💸 1 🌽 → 5 💩</button>
</div>

<div id="debug">
  <button id="btnCenter">🔎 Spieler zentrieren</button>
  <button id="btnReset">♻️ Neustart</button>
</div>

<script>
(() => {
  // --- Config ---
  const TILE = 48;                // tile size in CSS px
  const MAP_W = 40;               // tiles
  const MAP_H = 24;               // tiles
  const ROCK_SPAWN = 90;          // frames between rock spawn attempts
  const ROCK_MAX = 140;           // cap on rocks
  const MOVE_SPEED = 3.4;         // px per frame
  const CORN_TIME_MS = 60_000;    // 1 minute
  const CORN_CHANCE = 0.6;        // 60%
  const NEAR_DIST = TILE * 1.3;   // distance for merchant

  // Camera (simple pan so player is always on screen)
  const camera = { x: 0, y: 0 };

  // --- State ---
  const state = {
    player: { x: TILE*2, y: TILE*2, r: TILE*0.38 },
    merchant: { x: TILE*(MAP_W-5), y: TILE*(MAP_H-5) },
    stones: [],
    plants: [], // {x,y, plantedAt, readyAt, status}
    corns: [],  // items on ground
    inv: { stone:0, poop:0, corn:0 },
    frame: 0,
    keys: new Set(),
    pad: { up:false, down:false, left:false, right:false },
    rngSeed: (Date.now() ^ 0x9e3779b9) >>> 0,
    debugCenter: true,
  };

  function rand() {
    // xorshift32
    let x = state.rngSeed;
    x ^= x << 13; x ^= x >>> 17; x ^= x << 5;
    state.rngSeed = x >>> 0;
    return (state.rngSeed % 1_000_000) / 1_000_000;
  }

  // --- Canvas setup ---
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', { alpha:false });
  function resize() {
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const w = Math.floor(window.innerWidth);
    const h = Math.floor(window.innerHeight);
    canvas.style.width = w + "px";
    canvas.style.height = h + "px";
    canvas.width = Math.floor(w * dpr);
    canvas.height = Math.floor(h * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener('resize', resize, { passive:true });
  resize();

  // --- UI elements ---
  const lblStones = document.getElementById('stones');
  const lblPoops = document.getElementById('poops');
  const lblCorns = document.getElementById('corns');
  const lblPlants = document.getElementById('plants');
  const btnPlant = document.getElementById('btnPlant');
  const btnTrade = document.getElementById('btnTrade');
  const btnSellCorn = document.getElementById('btnSellCorn');
  const btnCenter = document.getElementById('btnCenter');
  const btnReset = document.getElementById('btnReset');
  const toast = document.getElementById('toast');
  const hud = document.getElementById('hud');

  btnCenter.addEventListener('click', ()=>{ state.debugCenter = true; say("Ansicht zentriert."); });
  btnReset.addEventListener('click', ()=>{ localStorage.removeItem('mk_save'); location.reload(); });

  // --- Map helpers ---
  function randomEmptyTile() {
    return {
      x: Math.floor(rand()*MAP_W) * TILE + TILE/2,
      y: Math.floor(rand()*MAP_H) * TILE + TILE/2
    };
  }

  // populate stones
  for (let i=0; i<80; i++) {
    const p = randomEmptyTile();
    state.stones.push({x:p.x, y:p.y});
  }

  // --- Controls ---
  window.addEventListener('keydown', (e) => state.keys.add(e.key.toLowerCase()));
  window.addEventListener('keyup',   (e) => state.keys.delete(e.key.toLowerCase()));

  // Touch dpad
  document.querySelectorAll('#dpad button').forEach(btn => {
    const dir = btn.dataset.dir;
    const on = (v)=> (ev)=>{ ev.preventDefault(); state.pad[dir] = v; };
    btn.addEventListener('touchstart', on(true), {passive:false});
    btn.addEventListener('touchend', on(false), {passive:false});
    btn.addEventListener('touchcancel', on(false), {passive:false});
  });

  // Actions
  btnPlant.addEventListener('click', plantPoop);
  btnTrade.addEventListener('click', doTrade);
  btnSellCorn.addEventListener('click', doSellCorn);

  function plantPoop() {
    if (state.inv.poop <= 0) return;
    const tileX = Math.round(state.player.x / TILE) * TILE + TILE/2;
    const tileY = Math.round(state.player.y / TILE) * TILE + TILE/2;
    const occupied = state.plants.some(p => Math.hypot(p.x - tileX, p.y - tileY) < TILE*0.25);
    if (occupied) return say("Hier wächst bereits etwas.");
    state.inv.poop--;
    const now = performance.now();
    state.plants.push({ x: tileX, y: tileY, plantedAt: now, readyAt: now + CORN_TIME_MS, status: 'growing' });
    lblPlants.textContent = state.plants.length;
    updateHUD();
    say("💩 Gedüngt! In ~1 Min könnte 🌽 wachsen…");
    save();
  }

  function doTrade() {
    if (!isNearMerchant()) return say("Geh näher an den Händler.");
    if (state.inv.stone >= 5) {
      state.inv.stone -= 5;
      state.inv.poop += 1;
      updateHUD(); say("🤝 Tausch: 5 🪨 → 1 💩"); save();
    } else say("Du brauchst 5 🪨 für 1 💩.");
  }

  function doSellCorn() {
    if (!isNearMerchant()) return say("Geh näher an den Händler.");
    if (state.inv.corn >= 1) {
      state.inv.corn -= 1;
      state.inv.poop += 5;
      updateHUD(); say("💸 Verkauf: 1 🌽 → 5 💩"); save();
    } else say("Du hast keinen 🌽.");
  }

  function say(msg) {
    toast.textContent = msg;
    toast.style.opacity = '1';
    clearTimeout(say._t);
    say._t = setTimeout(()=>toast.style.opacity='0', 1700);
  }

  function isNearMerchant() {
    const dx = state.player.x - state.merchant.x;
    const dy = state.player.y - state.merchant.y;
    return Math.hypot(dx,dy) < NEAR_DIST;
  }

  function updateHUD() {
    lblStones.textContent = state.inv.stone;
    lblPoops.textContent = state.inv.poop;
    lblCorns.textContent = state.inv.corn;
    lblPlants.textContent = state.plants.length;
    btnPlant.disabled = state.inv.poop <= 0;
    const near = isNearMerchant();
    btnTrade.disabled = !near;
    btnSellCorn.disabled = !near;
    hud.textContent = near ? "Bei Händler: Tausch möglich." : "Sammle Steine. Händler unten rechts.";
  }

  // --- Save/Load ---
  function save() {
    const data = JSON.stringify({ inv: state.inv, plants: state.plants, corns: state.corns });
    try { localStorage.setItem('mk_save', data); } catch {}
  }
  (function load(){
    try {
      const data = JSON.parse(localStorage.getItem('mk_save') || "null");
      if (!data) return;
      if (data.inv) state.inv = data.inv;
      if (Array.isArray(data.plants)) state.plants = data.plants;
      if (Array.isArray(data.corns)) state.corns = data.corns;
    } catch {}
  })();

  // --- Game loop ---
  function loop() {
    state.frame++;

    // movement
    let vx=0, vy=0;
    if (state.keys.has('arrowup') || state.keys.has('w') || state.pad.up) vy -= 1;
    if (state.keys.has('arrowdown') || state.keys.has('s') || state.pad.down) vy += 1;
    if (state.keys.has('arrowleft') || state.keys.has('a') || state.pad.left) vx -= 1;
    if (state.keys.has('arrowright') || state.keys.has('d') || state.pad.right) vx += 1;
    const len = Math.hypot(vx,vy) || 1;
    state.player.x = clamp(state.player.x + (vx/len)*MOVE_SPEED, TILE/2, MAP_W*TILE - TILE/2);
    state.player.y = clamp(state.player.y + (vy/len)*MOVE_SPEED, TILE/2, MAP_H*TILE - TILE/2);

    // camera follow
    if (state.debugCenter) {
      camera.x = clamp(state.player.x - canvas.clientWidth/2, 0, MAP_W*TILE - canvas.clientWidth);
      camera.y = clamp(state.player.y - canvas.clientHeight/2, 0, MAP_H*TILE - canvas.clientHeight);
    }

    // pick up stones
    for (let i=state.stones.length-1; i>=0; i--) {
      const s = state.stones[i];
      if (dist(s.x, s.y, state.player.x, state.player.y) < TILE*0.5) {
        state.stones.splice(i,1);
        state.inv.stone++; say("+1 🪨"); save();
      }
    }

    // rock respawn
    if (state.frame % ROCK_SPAWN === 0 && state.stones.length < ROCK_MAX) {
      for (let k=0; k<3; k++) {
        const p = randomEmptyTile();
        if (dist(p.x,p.y,state.player.x,state.player.y) > TILE*2 &&
            dist(p.x,p.y,state.merchant.x,state.merchant.y) > TILE*2) {
          state.stones.push({x:p.x, y:p.y});
        }
      }
    }

    // update plants (grow to corn after time, with chance)
    const now = performance.now();
    for (const pl of state.plants) {
      if (pl.status === 'growing' && now >= pl.readyAt) {
        pl.status = (rand() < CORN_CHANCE) ? 'ready' : 'fail';
        if (pl.status === 'ready') {
          state.corns.push({ x: pl.x, y: pl.y });
          say("🌽 Ein Mais ist gewachsen!");
        } else {
          say("🙃 Diesmal ist nichts gewachsen.");
        }
        save();
      }
    }

    // harvest corn by walking over it
    for (let i=state.corns.length-1; i>=0; i--) {
      const c = state.corns[i];
      if (dist(c.x, c.y, state.player.x, state.player.y) < TILE*0.5) {
        state.corns.splice(i,1);
        state.inv.corn++; say("+1 🌽 (beim Händler 5 💩 wert)"); save();
      }
    }

    // draw
    draw();

    // UI
    updateHUD();

    requestAnimationFrame(loop);
  }

  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
  function dist(ax,ay,bx,by){ return Math.hypot(ax-bx, ay-by); }

  function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.save();
    // apply camera (in CSS px)
    ctx.translate(-camera.x, -camera.y);

    // background grid
    for (let y=0; y<MAP_H; y++) {
      for (let x=0; x<MAP_W; x++) {
        const px = x*TILE, py = y*TILE;
        ctx.fillStyle = ((x+y)%2===0) ? "#0d3316" : "#12401e";
        ctx.fillRect(px, py, TILE, TILE);
      }
    }

    // merchant hut
    const hx = state.merchant.x - TILE, hy = state.merchant.y - TILE;
    ctx.fillStyle = "#5a3c23";
    ctx.fillRect(hx - TILE*0.5, hy - TILE*0.5, TILE*2, TILE*2);
    // hut roof
    ctx.fillStyle = "#7d4f2c";
    ctx.fillRect(hx - TILE*0.5, hy - TILE*0.8, TILE*2, TILE*0.3);
    // merchant sign
    ctx.fillStyle = "#f8f5e7";
    ctx.fillRect(hx + TILE*0.2, hy + TILE*0.9, TILE*1.6, TILE*0.5);
    ctx.fillStyle = "#2b2b2b";
    ctx.font = `bold ${Math.floor(TILE*0.4)}px system-ui`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("HÄNDLER", state.merchant.x, hy + TILE*1.15);

    // stones
    for (const s of state.stones) {
      ctx.fillStyle = "#b9c2cc";
      ctx.beginPath();
      ctx.ellipse(s.x, s.y, TILE*0.36, TILE*0.28, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.fillStyle = "#88929e";
      ctx.beginPath();
      ctx.ellipse(s.x - TILE*0.12, s.y - TILE*0.08, TILE*0.12, TILE*0.09, 0, 0, Math.PI*2);
      ctx.fill();
    }

    // plants patches
    for (const pl of state.plants) {
      if (pl.status === 'growing') {
        const t = Math.max(0, pl.readyAt - performance.now());
        const k = 1 - (t / CORN_TIME_MS);
        ctx.fillStyle = "#382a1d";
        ctx.beginPath();
        ctx.arc(pl.x, pl.y, TILE*0.34, 0, Math.PI*2);
        ctx.fill();
        // sprout
        ctx.fillStyle = "#63d16e";
        ctx.fillRect(pl.x - TILE*0.18, pl.y - k*TILE*0.32, TILE*0.36, k*TILE*0.32);
      } else if (pl.status === 'fail') {
        ctx.fillStyle = "#382a1d";
        ctx.beginPath();
        ctx.arc(pl.x, pl.y, TILE*0.3, 0, Math.PI*2);
        ctx.fill();
      }
    }

    // ready corns
    for (const c of state.corns) {
      // draw a simple corn icon
      ctx.save();
      ctx.translate(c.x, c.y);
      ctx.fillStyle = "#f2d24b"; // cob
      ctx.beginPath();
      ctx.ellipse(0, -TILE*0.05, TILE*0.16, TILE*0.26, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.fillStyle = "#5cbc6b"; // husk
      ctx.beginPath();
      ctx.moveTo(-TILE*0.22, 0);
      ctx.quadraticCurveTo(0, -TILE*0.35, TILE*0.22, 0);
      ctx.quadraticCurveTo(0, TILE*0.05, -TILE*0.22, 0);
      ctx.fill();
      ctx.restore();
    }

    // player (Poopboy) as visible circle with face
    ctx.save();
    ctx.translate(state.player.x, state.player.y);
    // body
    ctx.fillStyle = "#e6b35a";
    ctx.beginPath();
    ctx.arc(0, 0, state.player.r, 0, Math.PI*2);
    ctx.fill();
    // eyes
    ctx.fillStyle = "#111";
    ctx.beginPath(); ctx.arc(-state.player.r*0.3, -state.player.r*0.2, state.player.r*0.09, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc( state.player.r*0.3, -state.player.r*0.2, state.player.r*0.09, 0, Math.PI*2); ctx.fill();
    // smile
    ctx.lineWidth = 3;
    ctx.strokeStyle = "#111";
    ctx.beginPath(); ctx.arc(0, state.player.r*0.05, state.player.r*0.45, 0.15*Math.PI, 0.85*Math.PI); ctx.stroke();
    ctx.restore();

    ctx.restore();
  }

  // Kick off
  loop();
})();
</script>
</body>
</html>
